<div class="admin-dashboard">
  <header class="dashboard-header">
    <div class="header-content">
      <h1>Sistema de Reparto de Paquetes</h1>
      <div class="admin-controls">
        <button class="btn-primary" (click)="showAddPackageModal = true">
          <i class="icon">üì¶</i> Agregar Paquete
        </button>
        <button class="btn-secondary" (click)="logout()">
          <i class="icon">üö™</i> Cerrar Sesi√≥n
        </button>
      </div>
    </div>
  </header>
  
  <div class="dashboard-content">
    <section class="map-section">
      <h2>Mapa de Entregas</h2>
      <div class="map-container">
        <!-- Add this to your admin.component.html where the map component is used -->
        <app-map 
          [selectedDeliveryPerson]="selectedDeliveryPerson"
          #mapComponent
          (init)="onMapComponentInit(mapComponent)">
        </app-map>
      </div>
    </section>
    
    <section class="packages-section">
      <h2>Lista de Paquetes</h2>
      <app-package-table></app-package-table>
    </section>
    
    <!-- Nueva secci√≥n para listar repartidores -->
    <!-- Add this section to your HTML if it's not already there -->
    <section class="delivery-personnel-section">
      <h2><i class="icon">üöö</i> Lista de Repartidores</h2>
      <div class="delivery-list">
        <div class="delivery-list-header">
          <div class="delivery-header-item">ID</div>
          <div class="delivery-header-item">Nombre</div>
          <div class="delivery-header-item">Tel√©fono</div>
          <div class="delivery-header-item">Estado</div>
          <div class="delivery-header-item">Ubicaci√≥n</div>
          <div class="delivery-header-item">√öltima Actualizaci√≥n</div>
          <div class="delivery-header-item">Paquetes Asignados</div>
          <div class="delivery-header-item">Acciones</div>
        </div>
        
        <div class="delivery-list-body">
          <div class="delivery-item" *ngFor="let person of deliveryPersonnel">
            <div class="delivery-data">{{ person.id }}</div>
            <div class="delivery-data">{{ person.name }}</div>
            <div class="delivery-data">{{ person.phone || 'N/A' }}</div>
            <div class="delivery-data">
              <span class="status-badge" [ngClass]="person.status === 'available' ? 'status-available' : 'status-busy'">
                {{ person.status === 'available' ? 'Disponible' : 'Ocupado' }}
              </span>
            </div>
            <div class="delivery-data">
              <span *ngIf="person.latitude && person.longitude">
                {{ person.latitude | number:'1.6-6' }}, {{ person.longitude | number:'1.6-6' }}
              </span>
              <span *ngIf="!person.latitude || !person.longitude">Sin ubicaci√≥n</span>
            </div>
            <div class="delivery-data">
              {{ person.last_update | date:'dd/MM/yyyy HH:mm' }}
            </div>
            <div class="delivery-data">
              <span class="package-count-badge" 
                [ngClass]="{
                  'high-count': (person.packages?.length > 3), 
                  'medium-count': (person.packages?.length > 1 && person.packages?.length <= 3), 
                  'low-count': (person.packages?.length <= 1 || !person.packages)
                }">
                {{ person.packages?.length || 0 }}
                <span class="package-label">paquete{{ person.packages?.length !== 1 ? 's' : '' }}</span>
              </span>
            </div>
            <!-- Make sure this button is correctly defined in your HTML -->
            <div class="delivery-data delivery-actions">
              <button class="btn-view" (click)="selectDeliveryPerson(person)">
                <i class="icon">üëÅÔ∏è</i> Ver
              </button>
              <button class="btn-location" (click)="navigateToDeliveryPerson(person)" *ngIf="person.latitude && person.longitude">
                <i class="icon">üó∫Ô∏è</i> Ubicaci√≥n
              </button>
            </div>
          </div>
          
          <div class="no-deliveries" *ngIf="deliveryPersonnel.length === 0">
            No hay repartidores registrados.
          </div>
        </div>
      </div>
    </section>
  </div>
  
  <!-- Modal para agregar paquete -->
  <div class="modal" [class.show]="showAddPackageModal" (click)="closeModal($event)">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Agregar Nuevo Paquete</h3>
        <button class="close-btn" (click)="showAddPackageModal = false">√ó</button>
      </div>
      <app-add-package-form 
        (packageAdded)="onPackageAdded($event)"
        (cancel)="showAddPackageModal = false">
      </app-add-package-form>
    </div>
    <!-- Add this at the end of the file, before the closing </div> -->
    
    <!-- Modal para ver detalles del repartidor -->
    <div class="modal" [class.show]="selectedDeliveryPerson !== null" (click)="closeDeliveryPersonModal($event)">
      <div class="modal-content delivery-person-modal" (click)="$event.stopPropagation()" *ngIf="selectedDeliveryPerson">
        <div class="modal-header">
          <h3>Detalles del Repartidor</h3>
          <button class="close-btn" (click)="selectedDeliveryPerson = null">√ó</button>
        </div>
        <div class="modal-body">
          <div class="delivery-person-details">
            <div class="detail-row">
              <span class="detail-label">ID:</span>
              <span class="detail-value">{{ selectedDeliveryPerson.id }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Nombre:</span>
              <span class="detail-value">{{ selectedDeliveryPerson.name }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Tel√©fono:</span>
              <span class="detail-value">{{ selectedDeliveryPerson.phone || 'N/A' }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Email:</span>
              <span class="detail-value">{{ selectedDeliveryPerson.email || 'N/A' }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Estado:</span>
              <span class="detail-value status-badge" [ngClass]="selectedDeliveryPerson.status === 'available' ? 'status-available' : 'status-busy'">
                {{ selectedDeliveryPerson.status === 'available' ? 'Disponible' : 'Ocupado' }}
              </span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Ubicaci√≥n:</span>
              <span class="detail-value" *ngIf="selectedDeliveryPerson.latitude && selectedDeliveryPerson.longitude">
                {{ selectedDeliveryPerson.latitude | number:'1.6-6' }}, 
                {{ selectedDeliveryPerson.longitude | number:'1.6-6' }}
                <span *ngIf="isRemoteLocation(selectedDeliveryPerson)" class="remote-location-badge">
                  üåé Ubicaci√≥n remota
                </span>
              </span>
              <span class="detail-value" *ngIf="!selectedDeliveryPerson.latitude || !selectedDeliveryPerson.longitude">Sin ubicaci√≥n</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">√öltima actualizaci√≥n:</span>
              <span class="detail-value">{{ selectedDeliveryPerson.last_update | date:'dd/MM/yyyy HH:mm:ss' }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Paquetes asignados:</span>
              <span class="detail-value">{{ selectedDeliveryPerson.packages?.length || 0 }}</span>
            </div>
          </div>
          
          <div class="delivery-person-map" *ngIf="selectedDeliveryPerson.latitude && selectedDeliveryPerson.longitude">
            <h4>Ubicaci√≥n en el mapa</h4>
            <div id="delivery-person-detail-map" style="height: 300px; width: 100%; border-radius: 8px;"></div>
          </div>
          
          <div class="delivery-person-packages" *ngIf="selectedDeliveryPerson.packages?.length > 0">
            <h4>Paquetes asignados</h4>
            <table class="packages-mini-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Destinatario</th>
                  <th>Estado</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let pkg of selectedDeliveryPerson.packages">
                  <td>{{ pkg.id }}</td>
                  <td>{{ pkg.destinatario || pkg.recipient }}</td>
                  <td>
                    <span [class]="'status-' + pkg.status">
                      {{ pkg.status }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>